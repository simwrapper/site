import{r as L,g as k,k as F,R as d,M as j,d as tt,C as X,n as et}from"./index-24c2379b.js";import{d as st}from"./index-2d3640f5.js";import{r as it}from"./index-48474e4a.js";import{y as nt}from"./index-719eff74.js";import{n as C}from"./naturalSort-c3659ff7.js";import{c as rt}from"./index-48a773a4.js";import{H as at}from"./HTTPFileSystem-017e7593.js";import{P as ot,C as lt}from"./LegendColors-103b9dc7.js";import{Z as ct}from"./ZoomButtons-85071e8e.js";import{a as ht,p as dt,f as pt,g as ut}from"./util-8430d78c.js";import{W as mt}from"./RoadNetworkLoader.worker-ba4f3b4d.js";import{D as gt,S as ft}from"./set-rtl-text-plugin-40f27fec.js";import{P as vt}from"./PathOffsetLayer-df4f8747.js";import{P as yt}from"./path-layer-7a20967b.js";import{A as G}from"./arc-layer-85831471.js";import{T as Y,S as Z}from"./text-layer-98e63af8.js";import"./layer-7bd8a07e.js";import"./layer-extension-7e1876a6.js";import"./fxp-b80b6d05.js";const D={pickup:[0,150,255],delivery:[240,0,60],service:[255,64,255]};function kt(e){const[t,s]=L.useState(k.state.viewState),[i,n]=L.useState({}),[a,l]=L.useState({type:"activity",pickups:[],deliveries:[]}),{dark:g,activeTab:c,numSelectedTours:h,shipments:f,depots:p,legs:v,settings:T,stopActivities:_,center:H,onClick:P,projection:E}=e,{simplifyTours:B,scaleFactor:$,shipmentDotsOnTourMap:R}=T;let z=$==0?1e-6:1/Math.pow(2,(100-$)/5-6);const b=[];F[e.viewId]=()=>{s(k.state.viewState)},L.useEffect(()=>{const r={},o={};f.forEach(u=>{let m=`${u.fromX}-${u.fromY}`;r[m]||(r[m]={type:"pickup",shipmentIds:[],coord:[u.fromX,u.fromY]}),r[m].shipmentIds.push(u.$id),m=`${u.toX}-${u.toY}`,o[m]||(o[m]={type:"delivery",shipmentIds:[],coord:[u.toX,u.toY]}),o[m].shipmentIds.push(u.$id)}),l({type:"activity",pickups:Object.values(r),deliveries:Object.values(o)})},[f]);function A(r){r.object?P(r.object):P(null)}function x(r){s(r),r.center=[r.longitude,r.latitude],k.commit("setMapCamera",r)}function w(r){const{object:o}=r;return o?(o==null?void 0:o.type)=="pickup"?N(r,"pickup"):(o==null?void 0:o.type)=="delivery"?N(r,"delivery"):o!=null&&o.color?q(r):(o==null?void 0:o.type)=="depot"?null:J(r):null}function N(r,o){const{object:u,x:m,y:S}=r;return d.createElement("div",{className:"tooltip",style:{backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",opacity:.9,left:m+20,top:S+20}},d.createElement("table",{style:{maxWidth:"30rem",fontSize:"0.8rem"}},d.createElement("tbody",null,d.createElement("tr",null,d.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem",paddingTop:"0.2rem"}},o,":"),d.createElement("td",{style:{paddingTop:"0.2rem"}},u.shipmentIds.join(", "))))))}function q(r){var S,I;const{object:o,x:u,y:m}=r;return d.createElement("div",{className:"tooltip",style:{fontSize:"0.8rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:u+20,top:m-30}},d.createElement("b",null,(S=o==null?void 0:o.tour)==null?void 0:S.vehicleId),d.createElement("br",null),"Leg # ",1+(o==null?void 0:o.count)," ",d.createElement("br",null),"Shipments on board: ",(I=o==null?void 0:o.shipmentsOnBoard)==null?void 0:I.length," ",d.createElement("br",null),"Total size: ",o==null?void 0:o.totalSize)}function J(r){const{object:o,x:u,y:m}=r,S=o.visits.length,I=o.visits.reduce((y,O)=>y+O.pickup.length,0),W=o.visits.reduce((y,O)=>y+O.delivery.length,0),Q=I+W,U={visits:S,pickups:I,deliveries:W},V=Object.keys(o).length*20+32;let M=m-30;return M+V>window.innerHeight&&(M=m-V),d.createElement("div",{className:"tooltip",style:{fontSize:"0.7rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:u+20,top:M}},d.createElement("table",{style:{fontSize:"0.8rem"}},d.createElement("tbody",null,Object.keys(U).map(y=>d.createElement("tr",{key:y},d.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem"}},y,":"),d.createElement("td",{style:{fontWeight:"bold"}}," ",U[y]))),Q==1&&Object.keys(o.details).map(y=>d.createElement("tr",{key:y},d.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem",paddingTop:"0.2rem"}},y.slice(1),":"),d.createElement("td",{style:{paddingTop:"0.2rem"}},o.details[y]))))))}if(c=="tours"&&(b.push(new yt({id:"shipmentLocationDashedLine",data:_,getPath:r=>[r.ptFrom,r.ptTo],getColor:[128,128,128],getOffset:2,opacity:1,widthMinPixels:3,rounded:!0,shadowEnabled:!1,pickable:!1,autoHighlight:!1,highlightColor:[255,255,255],parameters:{depthTest:!1},getDashArray:[3,2],dashJustified:!0,extensions:[new ot({dash:!0})]})),B?b.push(new G({id:"leg-arcs",data:v,getSourcePosition:r=>r.points[0],getTargetPosition:r=>r.points[r.points.length-1],getSourceColor:r=>r.color,getTargetColor:r=>r.color,getWidth:$?r=>r.totalSize/2:3,getHeight:.5,widthMinPixels:2,widthMaxPixels:200,widthUnits:"pixels",widthScale:z,opacity:.9,parameters:{depthTest:!1},updateTriggers:{getWidth:[$]},transitions:{getWidth:150},pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n})):b.push(new vt({id:"deliveryroutes",data:v,getPath:r=>r.points,getColor:r=>r.color,getWidth:$?r=>r.totalSize:3,getOffset:2,opacity:1,widthMinPixels:3,widthMaxPixels:200,widthUnits:"pixels",widthScale:z,rounded:!0,shadowEnabled:!1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n,parameters:{depthTest:!1},updateTriggers:{getWidth:[$]},transitions:{getWidth:150}})),b.push(new Y({id:"dest-labels",data:_,background:!0,backgroundPadding:h!==1?[2,1,2,1]:[3,2,3,1],getColor:[255,255,255],getBackgroundColor:r=>{const o=r.visits.reduce((m,S)=>m+S.pickup.length,0),u=r.visits.reduce((m,S)=>m+S.delivery.length,0);return o&&u?[0,0,255]:o?D.pickup:u?D.delivery:[240,130,0]},getPosition:r=>r.midpoint,getText:r=>r.label=="Depot"?r.label:h!==1?" ":`${r.label}`,getSize:r=>r.label=="Depot"?11:h!==1?4:11,getTextAnchor:"middle",getAlignmentBaseline:"center",opacity:1,noAlloc:!1,billboard:!0,sizeScale:1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n,visible:R}))),c=="shipments"){b.push(new Z({id:"deliveries",data:a.deliveries,getPosition:o=>o.coord,getColor:D.delivery,getRadius:3,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:n})),b.push(new Z({id:"pickups",data:a.pickups,getPosition:o=>o.coord,getColor:D.pickup,getRadius:2,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:n}));const r=f.length>1?32:255;b.push(new G({id:"shipments",data:f,getSourcePosition:o=>[o.fromX,o.fromY],getTargetPosition:o=>[o.toX,o.toY],getSourceColor:[0,228,255,r],getTargetColor:[240,0,60,224],getWidth:$?o=>parseInt(o.$size)||1:1,widthUnits:"pixels",getHeight:.5,opacity:.9,parameters:{depthTest:!1},widthScale:z,widthMinPixels:1,widthMaxPixels:100,updateTriggers:{getWidth:[$]},transitions:{getWidth:200}}))}b.push(new Y({id:"depots",data:p,background:!0,backgroundPadding:[3,2,3,1],getColor:[255,255,255],getBackgroundColor:[0,150,240],getPosition:r=>r.midpoint,getText:r=>"Depot",getTextAnchor:"middle",getAlignmentBaseline:"center",getSize:11,opacity:1,noAlloc:!1,billboard:!0,sizeScale:1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n}));const K=E&&E!=="Atlantis";return d.createElement(gt,{layers:b,pickingRadius:3,controller:!0,getCursor:()=>"pointer",onClick:A,viewState:t,onViewStateChange:r=>x(r.viewState)},K&&d.createElement(ft,{mapboxApiAccessToken:j,mapStyle:k.getters.mapStyle}),w(i))}const bt={messages:{en:{carriers:"Carriers",vehicles:"VEHICLES",services:"SERVICES",shipments:"SHIPMENTS",tours:"TOURS",pickup:"Pickup",delivery:"Delivery",flatten:"Simple&nbsp;tours",shipmentDots:"Show shipments",scaleSize:"Widths",scaleFactor:"Width"},de:{carriers:"Unternehmen",vehicles:"FAHRZEUGE",services:"BETRIEBE",shipments:"LIEFERUNGEN",tours:"TOUREN",pickup:"Abholung",delivery:"Lieferung"}}};C.insensitive=!0;const St=tt({name:"CarrierPlugin",i18n:bt,components:{LegendColors:lt,ToggleButton:st.ToggleButton,TourViz:kt,ZoomButtons:ct},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean},data:()=>({linkLayerId:Math.floor(1e12*Math.random()),vizSettings:{simplifyTours:!1,scaleShipmentSizes:!0,shipmentDotsOnTourMap:!0,scaleFactor:0},vizDetails:{network:"",carriers:"",projection:"",title:"",description:"",thumbnail:"",center:null},myState:{statusMessage:"",isRunning:!1,subfolder:"",yamlConfig:"",thumbnail:!0,data:[]},searchTerm:"",searchEnabled:!1,globalState:k.state,isLoaded:!0,showHelp:!1,activeTab:"shipments",speedStops:[-10,-5,-2,-1,-.5,-.25,0,.25,.5,1,2,5,10],speed:1,legendBits:[],links:null,toggleTours:!0,toggleVehicles:!0,toggleShipments:!0,toggleServices:!0,detailContent:"",data:null,carriers:[],vehicles:[],shipments:[],shipmentLookup:{},services:[],stopActivities:[],tours:[],plans:[],shownShipments:[],shipmentIdsInTour:[],depots:[],shownDepots:[],shownLegs:[],selectedCarrier:"",selectedTours:[],selectedPlan:null,selectedPlanIndex:null,selectedShipment:null,thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",vehicleLookup:[],vehicleLookupString:{},rgb:rt({colormap:"phase",nshades:9,format:"rba"}).map(e=>e.slice(0,3)).reverse(),dropdownIsActive:!1}),computed:{fileApi(){return new at(this.fileSystem,k)},fileSystem(){const e=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(e.length===0)throw console.log("no such project"),Error;return e[0]},urlThumbnail(){return this.thumbnailUrl},textColor(){const e={text:"#3498db",bg:"#eeeef480"},t={text:"white",bg:"#181518aa"};return this.globalState.isDarkMode?t:e}},watch:{"$store.state.viewState"(){F[this.linkLayerId]&&F[this.linkLayerId]()},"globalState.isDarkMode"(){this.updateLegendColors()},async"globalState.authAttempts"(){console.log("AUTH CHANGED - Reload"),this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails()}},methods:{handleSelectShipment(e){if(this.selectedShipment===e){if(this.selectedShipment=null,this.shownShipments=[],!this.selectedTours.length){const t=this.carriers.filter(s=>s.$id==this.selectedCarrier);this.selectedCarrier="",this.handleSelectCarrier(t[0])}return}this.shownShipments=this.shipments.filter(t=>t.$id===e.$id),this.selectedShipment=e},processActivitiesInTour(e){const t=[];let s=0;const i={};let n=this.vehicles.filter(h=>h.$id===e.vehicleId)[0];const a=this.links[n.$depotLinkId];let l=[.5*(a[0]+a[2]),.5*(a[1]+a[3])],g=n.$depotLinkId;i[`L${n.$depotLinkId}`]={link:n.$depotLinkId,midpoint:l,visits:[{pickup:[],delivery:[],service:[]}],label:"",tour:e,details:{},ptFrom:[a[0],a[1]],ptTo:[a[2],a[3]]};for(const h of e.plan){if(!h.$shipmentId)continue;t.push(h.$shipmentId);const f=this.shipmentLookup[h.$shipmentId];if(!f)continue;const p=h.$type==="pickup"?f.$from:f.$to,v=[this.links[p][0],this.links[p][1]],T=[this.links[p][2],this.links[p][3]],_=[.5*(v[0]+T[0]),.5*(v[1]+T[1])],H=this.$t(h.$type),{from:P,fromX:E,fromY:B,to:$,toX:R,toY:z,id:b,...A}=f,x={id:f.$id,type:H,count:s++,link:p,midpoint:_,label:"",tour:e,details:A,ptFrom:v,ptTo:T};if(p==g)i[`L${p}`].visits[i[`L${p}`].visits.length-1][h.$type].push(x);else if(`L${p}`in i){const w={pickup:[],delivery:[],service:[]};w[h.$type].push(x),i[`L${p}`].visits.push(w)}else{const w={pickup:[],delivery:[],service:[]};w[h.$type].push(x),i[`L${p}`]={link:p,midpoint:_,label:"",tour:e,details:A,ptFrom:v,ptTo:T,visits:[w]}}g=p}const c=Object.values(i);for(let h=0;h<c.length;h++)c[h].label=`${h}`;return c[0].label="Depot",{shipmentIdsInTour:t,stopActivities:c}},setupDepots(){const e={};this.vehicles.forEach(t=>{const s=t.$depotLinkId;let i=this.links[s];i&&(e[s]||(e[s]={type:"depot",link:t.$depotLinkId,midpoint:[.5*(i[0]+i[2]),.5*(i[1]+i[3])],coords:this.links[t.$depotLinkId],vehicles:{}}),e[s].vehicles[t.$id]=t)}),this.depots=Object.values(e),this.shownDepots=this.depots.slice(0)},selectAllTours(){this.selectedTours=[],this.shownLegs=[],this.stopActivities=[],this.shownDepots=[],this.shownShipments=this.shipments.slice(0);for(const e of this.tours){e.legs.forEach((s,i)=>this.addRouteToMap(e,s,i++));const t=this.processActivitiesInTour(e);this.stopActivities=this.stopActivities.concat(t.stopActivities),this.setupDepots()}},async handleSelectTour(e){if(!e.legs.length){console.log("No Route.");for(let n=0;n<e.plan.length;n++)if(e.plan[n].$shipmentId){const a=e.plan[n].$shipmentId,l=[this.shipmentLookup[a].$from,this.shipmentLookup[a].$to];e.legs.push({links:l})}this.vizSettings.simplifyTours=!0}if(this.selectedTours.includes(e)){this.selectedTours=this.selectedTours.filter(n=>n!==e),this.shownLegs=this.shownLegs.filter(n=>n.tour!==e),this.stopActivities=this.stopActivities.filter(n=>n.tour!==e),this.selectedTours.length||this.selectAllTours();return}this.selectedTours.length||(this.selectedTours=[],this.shownLegs=[],this.stopActivities=[],this.shownDepots=[]),this.selectedTours.push(e);const{shipmentIdsInTour:t,stopActivities:s}=this.processActivitiesInTour(e);this.shipmentIdsInTour=t;let i=0;for(const n of e.legs)this.addRouteToMap(e,n,i++);this.stopActivities=this.stopActivities.concat(s)},addRouteToMap(e,t,s){const i=[[this.links[t.links[0]][0],this.links[t.links[0]][1]]];for(const n of t.links){const a=i[i.length-1],l=[this.links[n][0],this.links[n][1]];(l[0]!==a[0]||l[1]!==a[1])&&i.push(l),i.push([this.links[n][2],this.links[n][3]])}this.shownLegs=this.shownLegs.concat([{tour:e,shipmentsOnBoard:t.shipmentsOnBoard,totalSize:t.totalSize,count:s,points:i,color:this.rgb[(3+e.tourNumber)%this.rgb.length],type:"leg"}])},handleSelectCarrier(e){var i,n;if(this.dropdownIsActive=!1,!this.links)return;const t=e.$id;if(this.vehicles=[],this.shipments=[],this.services=[],this.tours=[],this.plans=[],this.shownShipments=[],this.shownDepots=[],this.selectedShipment=null,this.shipmentIdsInTour=[],this.stopActivities=[],this.shownLegs=[],this.selectedCarrier===t){this.selectedCarrier="";return}this.selectedCarrier=t;let s=e.capabilities.vehicles.vehicle||[];this.vehicles=s.sort((a,l)=>C(a,l)),this.setupDepots(),this.shipments=this.processShipments(e),(n=(i=e.services)==null?void 0:i.service)!=null&&n.length&&(this.services=e.services.service.map(a=>a.$).sort((a,l)=>C(a.$id,l.$id))),this.tours=this.processTours(e),this.shownShipments=this.shipments,this.selectAllTours()},getAllPlans(e){if(e.plan!=null){this.plans.push(e.plan),this.selectedPlan=e.plan;return}if(e.plans!=null){if(e.plans.plan.length==null){this.plans.push(e.plans.plan),this.selectedPlan=e.plans.plan;return}this.plans=e.plans.plan;for(let t=0;t<e.plans.plan.length;t++){if(e.plans.plan[t].selected=="true"){this.selectedPlan=e.plans.plan[t];break}this.selectedPlan=e.plans.plan[t]}}},processTours(e){if(this.getAllPlans(e),!this.selectPlan||!this.plans.length)return[];Array.isArray(this.selectedPlan.tour)||(this.selectedPlan.tour=[this.selectedPlan.tour]);const t=this.selectedPlan.tour.map((s,i)=>{const n=[s.act[0]],a=new Set;for(let c=1;c<s.act.length;c++)s.leg[c-1].shipmentsOnBoard=[...a],n.push(s.leg[c-1]),n.push(s.act[c]),s.act[c].$type=="pickup"&&s.act[c].$shipmentId&&a.add(s.act[c].$shipmentId),s.act[c].$type=="delivery"&&s.act[c].$shipmentId&&a.delete(s.act[c].$shipmentId);const l=s.leg.filter(c=>c.route&&c.route.length).map(c=>{const h=c.shipmentsOnBoard.map(p=>this.shipmentLookup[p]),f=h.reduce((p,v)=>p+parseFloat((v==null?void 0:v.$size)||0),0);return{shipmentsOnBoard:h,totalSize:f,links:c.route?c.route.split(" "):[]}});return{vehicleId:s.$vehicleId,tourId:s.$tourId,plan:n,legs:l,tourNumber:0}});return t.sort((s,i)=>C(s.vehicleId,i.vehicleId)),t.forEach((s,i)=>s.tourNumber=i),t},processShipments(e){var s,i;if(this.shipmentLookup={},!((i=(s=e.shipments)==null?void 0:s.shipment)!=null&&i.length))return[];const t=e.shipments.shipment.sort((n,a)=>C(n.$id,a.$id));try{for(const n of t)n.fromX=.5*(this.links[n.$from][0]+this.links[n.$from][2]),n.fromY=.5*(this.links[n.$from][1]+this.links[n.$from][3]),n.toX=.5*(this.links[n.$to][0]+this.links[n.$to][2]),n.toY=.5*(this.links[n.$to][1]+this.links[n.$to][3]),this.shipmentLookup[n.$id]=n}catch{}return t},buildRouteFromUrl(){const e=this.$route.params;if(!e.project||!e.pathMatch){console.log("I CANT EVEN: NO PROJECT/PARHMATCH");return}const t=1+e.pathMatch.lastIndexOf("/"),s=e.pathMatch.substring(0,t),i=e.pathMatch.substring(t);this.myState.subfolder=s,this.myState.yamlConfig=i},async getVizDetails(){var n,a;if(this.config){this.vizDetails=Object.assign({},this.config);return}if((n=this.yamlConfig)!=null&&n.endsWith("yaml")||(a=this.yamlConfig)!=null&&a.endsWith("yml"))try{const l=this.yamlConfig.indexOf("/")>-1?this.yamlConfig:this.subfolder+"/"+this.yamlConfig,g=await this.fileApi.getFileText(l);this.vizDetails=nt.parse(g);return}catch(l){console.log("failed"+l);const g=l;this.fileSystem.needPassword&&g.status===401?k.commit("requestLogin",this.fileSystem.slug):this.$emit("error",""+l);return}const e=this.myState.yamlConfig.substring(0,15+this.myState.yamlConfig.indexOf("carriers")),{files:t}=await this.fileApi.getDirectory(this.myState.subfolder);let s=this.myState.yamlConfig.replaceAll("carriers","network");if(t.indexOf(s)==-1){const l=t.filter(g=>g.indexOf("network")>-1);l.length?s=l[0]:(this.myState.statusMessage="No road network found.",s="")}this.vizDetails={network:s,carriers:this.yamlConfig,title:e,description:"",center:this.vizDetails.center,projection:"",thumbnail:""};const i="Carrier Explorer";this.$emit("title",i),this.buildThumbnail()},async setMapCenter(){let e=0,t=0,s=0;if(this.vizDetails.center)typeof this.vizDetails.center=="string"&&(this.vizDetails.center=this.vizDetails.center.split(",").map(Number)),t=this.vizDetails.center[0],s=this.vizDetails.center[1];else if(!this.vizDetails.center){if(this.data=Object.entries(this.links),!this.data.length)return;const i=this.data.length/2,n=4096;for(let a=0;a<i;a+=n)t+=this.data[a*2][1][0],s+=this.data[a*2+1][1][1],e++;t=t/e,s=s/e}t&&s&&this.$store.commit("setMapCamera",{longitude:t,latitude:s,zoom:9,bearing:0,pitch:0,jump:!1})},async buildThumbnail(){if(this.thumbnail&&this.vizDetails.thumbnail)try{const e=await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail),t=await it.arraybuffer(e),s=ht(t);s&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${s})`)}catch(e){console.error(e)}},handleClick(e){console.log("CLICK!",e),e||this.clickedEmptyMap(),(e==null?void 0:e.type)=="depot"&&this.clickedDepot(e),(e==null?void 0:e.type)=="leg"&&this.clickedLeg(e)},clickedDepot(e){const t=Object.values(e.vehicles).map(s=>s.$id);this.selectedTours=[],this.shownShipments=[];for(const s of this.tours)t.includes(s.vehicleId)&&(this.handleSelectTour(s),this.shipmentIdsInTour.forEach(i=>{this.shownShipments.push(this.shipmentLookup[i])}))},clickedLeg(e){e!=null&&e.tour&&this.handleSelectTour(e==null?void 0:e.tour)},clickedEmptyMap(){this.selectAllTours()},updateLegendColors(){},async loadCarriers(){const e=await this.loadFileOrGzippedFile(this.vizDetails.carriers);return e?(await dt(e,{alwaysArray:["carriers.carrier","carriers.carrier.capabilities.vehicles.vehicle","carriers.carrier.plan.tour","carriers.carrier.shipments.shipment","carriers.carrier.services.service"]})).carriers.carrier.sort((i,n)=>C(i.$id,n.$id)):[]},async loadNetwork(){if(this.myState.statusMessage="Loading network...",this.vizDetails.network.indexOf(".xml.")>-1){const e=`${this.myState.subfolder}/${this.vizDetails.network}`,t=await this.fetchNetwork(e,{});this.vizDetails.projection=""+t.projection,this.myState.statusMessage="Building network link table";const s={};return t.linkIds.forEach((i,n)=>{s[i]=[t.source[n*2],t.source[n*2+1],t.dest[n*2],t.dest[n*2+1]]}),s}else{const e=await this.fileApi.getFileJson(this.myState.subfolder+"/"+this.vizDetails.network);return this.vizDetails.projection="EPSG:4326",e}},async fetchNetwork(e,t){return new Promise((s,i)=>{const n=new mt;try{n.postMessage({filePath:e,fileSystem:this.fileSystem,vizDetails:t}),n.onmessage=a=>{if(a.data.promptUserForCRS){let l=prompt("Enter the coordinate reference system, e.g. EPSG:25832")||"EPSG:31468";Number.isFinite(parseInt(l))&&(l=`EPSG:${l}`),n.postMessage({crs:l});return}if(a.data.status){this.myState.statusMessage=""+a.data.status;return}n.terminate(),a.data.error&&(console.error(a.data.error),k.commit("error",a.data.error),this.myState.statusMessage=a.data.error,i(a.data.error)),s(a.data.links)}}catch(a){n.terminate(),console.error(a),i(a)}})},toggleLoaded(e){this.isLoaded=e},rotateColors(){localStorage.setItem("plugin/agent-animation/colorscheme",this.globalState.isDarkMode?X.DarkMode:X.LightMode)},async loadFileOrGzippedFile(e){let t=`${this.subfolder}/${e}`;try{if(t.indexOf("*")>-1||t.indexOf("?")>-1){const n=t.substring(1+t.lastIndexOf("/")),a=t.substring(0,t.lastIndexOf("/")),{files:l}=await this.fileApi.getDirectory(a),g=pt(l,n);if(g.length==0)throw Error(`No files matched "${n}"`);if(g.length>1)throw Error(`More than one file matched "${n}": ${g}`);t=`${a}/${g[0]}`}let i="";if(t.endsWith("xml")||t.endsWith("gz")){const a=await(await this.fileApi.getFileBlob(t)).arrayBuffer(),l=ut(a);return new TextDecoder("utf-8").decode(l)}}catch{}const s=`Error loading ${t}`;return k.commit("error",s),this.myState.statusMessage=s,""},selectDropdown(){this.dropdownIsActive=!this.dropdownIsActive},selectPlan(e){for(let t=0;t<this.plans.length;t++)this.plans[t].$selected="false";e.$selected="true",this.selectedPlanIndex=this.plans.indexOf(e),this.selectedTours=[],this.selectDropdown(),this.selectedPlan=e}},async mounted(){k.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.subfolder=this.subfolder,this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails(),!this.thumbnail&&(this.showHelp=!1,this.updateLegendColors(),this.myState.statusMessage="Loading carriers...",this.carriers=await this.loadCarriers(),await this.$nextTick(),this.links=await this.loadNetwork(),this.setMapCenter(),this.myState.statusMessage="",this.carriers.length&&this.handleSelectCarrier(this.carriers[0]),this.tours.length&&this.handleSelectTour(this.tours[0]))},beforeDestroy(){this.myState.isRunning=!1,k.commit("setFullScreen",!1),this.$store.commit("setFullScreen",!1)}});var $t=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"carrier-viewer",class:{"hide-thumbnail":!t.thumbnail},style:{background:t.urlThumbnail},attrs:{oncontextmenu:"return false"}},[s("div",{staticClass:"container-1"},[s("div",{staticClass:"main-panel"},[t.thumbnail?t._e():s("tour-viz",{staticClass:"anim",attrs:{activeTab:t.activeTab,shipments:t.shownShipments,depots:t.shownDepots,legs:t.shownLegs,stopActivities:t.stopActivities,dark:t.globalState.isDarkMode,center:t.vizDetails.center,viewId:t.linkLayerId,settings:t.vizSettings,numSelectedTours:t.selectedTours.length,onClick:t.handleClick,projection:t.vizDetails.projection}}),t.thumbnail?t._e():s("ZoomButtons"),t.myState.statusMessage?s("div",{staticClass:"xmessage"},[t._v(t._s(t.myState.statusMessage))]):t._e()],1),t.thumbnail?t._e():s("div",{staticClass:"right-panel",attrs:{darkMode:!0}},[t.carriers.length?s("h3",{staticStyle:{"margin-left":"0.25rem"}},[t._v(t._s(t.$t("carriers")))]):t._e(),s("div",{staticClass:"carrier-list"},t._l(t.carriers,function(i){return s("div",{key:i.$id,staticClass:"carrier",class:{selected:i.$id===t.selectedCarrier},on:{click:function(n){return t.handleSelectCarrier(i)}}},[s("div",{staticClass:"carrier-title"},[t._v(t._s(i.$id))])])}),0),s("h4",[t._v(t._s(t.selectedCarrier||"Details"))]),t.selectedCarrier?s("b-field",{staticClass:"detail-buttons",attrs:{size:"is-small"}},[s("b-radio-button",{attrs:{"native-value":"shipments",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(i){t.activeTab=i},expression:"activeTab"}},[s("span",[t._v(t._s(t.$t("shipments")))])]),s("b-radio-button",{attrs:{"native-value":"tours",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(i){t.activeTab=i},expression:"activeTab"}},[s("span",[t._v(t._s(t.$t("tours")))])]),s("b-radio-button",{attrs:{"native-value":"vehicles",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(i){t.activeTab=i},expression:"activeTab"}},[s("span",[t._v(t._s(t.$t("vehicles")))])]),t.services.length?s("b-radio-button",{attrs:{"native-value":"services",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(i){t.activeTab=i},expression:"activeTab"}},[s("span",[t._v(t._s(t.$t("services")))])]):t._e()],1):t._e(),s("div",{staticClass:"detail-area"},[t.activeTab=="shipments"?s("div",{staticClass:"shipments"},[s("span",[t._v(t._s(t.$t("shipments"))+": "+t._s(t.shipments.length))]),t._l(t.shipments,function(i,n){return s("div",{key:`${n}-${i.$id}`,staticClass:"leaf tour",class:{selected:i==t.selectedShipment,"shipment-in-tour":t.shipmentIdsInTour.includes(i.$id)},on:{click:function(a){return t.handleSelectShipment(i)}}},[t._v(t._s(`${i.$id}: ${i.$from}-${i.$to}`))])})],2):t._e(),t.activeTab=="tours"?s("div",{staticClass:"tours"},[this.plans.length>1?s("div",{staticClass:"dropdown",class:{"is-active":t.dropdownIsActive},staticStyle:{width:"100%"}},[s("div",{staticClass:"dropdown-trigger",on:{click:function(i){return t.selectDropdown()}}},[s("button",[s("span",[t._v("Plan "+t._s(t.selectedPlanIndex+1))]),t._m(0)])]),s("div",{staticClass:"dropdown-menu"},[s("div",{staticClass:"dropdown-content"},t._l(this.plans,function(i,n){return s("a",{staticClass:"dropdown-item",class:{"is-active":i.$selected=="true"},on:{click:function(a){return t.selectPlan(i)}}},[t._v("Plan "+t._s(n+1))])}),0)])]):t._e(),s("span",[t._v(t._s(t.$t("tours"))+": "+t._s(t.tours.length))]),t._l(t.tours,function(i,n){return s("div",{key:`${n}-${i.$id}`,staticClass:"leaf tour",class:{selected:t.selectedTours.includes(i)},on:{click:function(a){return t.handleSelectTour(i)}}},[i.tourId?s("div",[t._v(t._s(i.tourId)+": "+t._s(`${i.vehicleId}`))]):s("div",[t._v(t._s(`${i.vehicleId}`))])])})],2):t._e(),t.activeTab=="vehicles"?s("div",{staticClass:"vehicles"},[s("span",[t._v(t._s(t.$t("vehicles"))+": "+t._s(t.vehicles.length))]),t._l(t.vehicles,function(i,n){return s("div",{key:`${n}-${i.$id}`,staticClass:"leaf tour"},[t._v(t._s(i.$id))])})],2):t._e(),t.activeTab=="services"?s("div",{staticClass:"services"},[s("span",[t._v(t._s(t.$t("services"))+": "+t._s(t.services.length))]),t._l(t.services,function(i,n){return s("div",{key:`${n}-${i.$id}`,staticClass:"leaf tour"},[t._v(t._s(`${i.$id}`))])})],2):t._e()]),s("div",{staticClass:"switchbox"},[s("div",{staticClass:"switches"},[s("p",[t._v(t._s(t.$t("scaleSize")))]),s("b-slider",{staticClass:"slider",attrs:{tooltip:!1,type:"is-link",size:"is-small"},model:{value:t.vizSettings.scaleFactor,callback:function(i){t.$set(t.vizSettings,"scaleFactor",i)},expression:"vizSettings.scaleFactor"}})],1),s("div",{staticClass:"switches"},[s("b-switch",{model:{value:t.vizSettings.shipmentDotsOnTourMap,callback:function(i){t.$set(t.vizSettings,"shipmentDotsOnTourMap",i)},expression:"vizSettings.shipmentDotsOnTourMap"}},[s("span",{domProps:{innerHTML:t._s(t.$t("shipmentDots"))}})]),s("b-switch",{model:{value:t.vizSettings.simplifyTours,callback:function(i){t.$set(t.vizSettings,"simplifyTours",i)},expression:"vizSettings.simplifyTours"}},[s("span",{domProps:{innerHTML:t._s(t.$t("flatten"))}})])],1)])],1)])])},wt=[function(){var e=this,t=e._self._c;return e._self._setupProxy,t("span",{staticClass:"icon is-small"},[t("i",{staticClass:"fas fa-angle-down"})])}];var Tt=et(St,$t,wt,!1,null,"f679dd7f",null,null);const Vt=Tt.exports;export{Vt as default};
//# sourceMappingURL=CarrierViewer-6be9b664.js.map
