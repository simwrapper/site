{"version":3,"file":"screenshots-b8b183dc.js","sources":["../../src/components/BackgroundMapOnTop.vue","../../src/js/screenshots.ts"],"sourcesContent":["<template lang=\"pug\">\n.mymaplibre-map(:id=\"containerId\")\n  .mymap(:id=\"mapId\")\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\nimport maplibregl, { MapMouseEvent, PositionOptions } from 'maplibre-gl'\n\nimport globalStore from '@/store'\nimport { ColorScheme, REACT_VIEW_HANDLES } from '@/Globals'\n\nconst Component = defineComponent({\n  name: 'BackgroundMapOnTop',\n  components: {},\n  data: () => {\n    return {\n      containerId: `c${Math.floor(1e12 * Math.random())}`,\n      globalState: globalStore.state,\n      isDarkMode: false,\n      isMapMoving: false,\n      mapId: `map-${Math.floor(1e12 * Math.random())}`,\n      layerId: Math.floor(1e12 * Math.random()),\n      mymap: {} as maplibregl.Map,\n      resizer: null as ResizeObserver | null,\n      isMapReady: false,\n    }\n  },\n  computed: {},\n  methods: {\n    setupResizer() {\n      this.resizer = new ResizeObserver(() => {\n        this.mymap.resize()\n      })\n\n      const viz = document.getElementById(this.containerId) as HTMLElement\n      this.resizer.observe(viz)\n    },\n    handleMapMotion() {\n      if (!this.isMapReady) return\n\n      const mapCamera = {\n        longitude: this.mymap.getCenter().lng,\n        latitude: this.mymap.getCenter().lat,\n        bearing: this.mymap.getBearing(),\n        zoom: this.mymap.getZoom(),\n        pitch: this.mymap.getPitch(),\n      }\n\n      this.$store.commit('setMapCamera', mapCamera)\n      if (!this.isMapMoving) this.isMapMoving = true\n    },\n\n    setupMap() {\n      const styles = globalStore.state.mapStyles\n      try {\n        this.mymap = new maplibregl.Map({\n          container: this.mapId,\n          style: this.isDarkMode ? styles.transparentDark : styles.transparentLight,\n          logoPosition: 'top-left',\n        })\n\n        // make sure it starts up aligned with main map\n        const { jump, initial, startup, ...viewState } = this.globalState.viewState\n        viewState.center = [viewState.longitude, viewState.latitude]\n        this.mymap.jumpTo(viewState as any)\n      } catch (e) {\n        console.error('HUH?' + e)\n        return\n      }\n\n      // Start doing stuff AFTER the MapLibre library has fully initialized\n      this.mymap.on('load', this.mapIsReady)\n\n      // Always hide map controls\n      let baubles = document.getElementsByClassName(\n        'mapboxgl-ctrl mapboxgl-ctrl-attrib mapboxgl-compact'\n      )\n      for (const elem of baubles) elem.setAttribute('style', 'display: none')\n\n      baubles = document.getElementsByClassName('mapboxgl-ctrl mapboxgl-ctrl-group')\n      for (const elem of baubles) elem.setAttribute('style', 'display: none')\n\n      baubles = document.getElementsByClassName('mapboxgl-ctrl-logo')\n      for (const elem of baubles) elem.setAttribute('style', 'display: none')\n    },\n\n    async mapIsReady() {\n      this.isMapReady = true\n      this.setupResizer()\n      this.mymap.on('move', this.handleMapMotion)\n    },\n\n    viewMoved(value: any) {\n      if (!this.isMapReady) return\n\n      if (!this.mymap || this.isMapMoving) {\n        this.isMapMoving = false\n        return\n      }\n\n      const { bearing, longitude, latitude, zoom, pitch } = value\n\n      // sometimes closing a view returns a null map, ignore it!\n      if (!longitude || !latitude || !zoom) {\n        return\n      }\n\n      this.mymap.off('move', this.handleMapMotion)\n\n      this.mymap.jumpTo({\n        bearing,\n        zoom,\n        center: [longitude, latitude],\n        pitch,\n      })\n\n      this.mymap.on('move', this.handleMapMotion)\n    },\n  },\n\n  watch: {\n    'globalState.viewState'(value: any) {\n      this.viewMoved(value)\n    },\n\n    '$store.state.colorScheme'() {\n      this.isDarkMode = this.$store.state.colorScheme === ColorScheme.DarkMode\n      if (!this.mymap) return\n\n      const styles = globalStore.state.mapStyles\n      this.mymap.setStyle(this.isDarkMode ? styles.transparentDark : styles.transparentLight)\n\n      this.mymap.on('style.load', () => {})\n    },\n\n    '$store.state.resizeEvents'() {\n      if (this.mymap) this.mymap.resize()\n    },\n  },\n\n  mounted() {\n    this.isDarkMode = this.$store.state.colorScheme === ColorScheme.DarkMode\n    this.setupMap()\n  },\n})\nexport default Component\n</script>\n\n<style scoped lang=\"scss\">\n@import '@/styles.scss';\n\n.mymaplibre-map {\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  pointer-events: none;\n}\n\n.mymap {\n  height: 100%;\n}\n</style>\n","// screenshot helper functions\n// found most of this at:\n// (1) https://github.com/visgl/deck.gl/issues/4436\n// (2) https://stackoverflow.com/questions/32096540/merge-two-datauris-to-create-a-single-image\n\nimport { DeckGLLayer } from '@flowmap.gl/core'\n\nexport async function savePNG(layer: DeckGLLayer, backgroundCanvas: HTMLCanvasElement) {\n  const deckLayerImage = layer.context.deck.canvas.toDataURL('image/png')\n  const backgroundImage = backgroundCanvas?.toDataURL('image/png')\n\n  const layerData = []\n  if (backgroundImage) layerData.push(backgroundImage)\n  layerData.push(deckLayerImage)\n\n  // convert deck+map to image URL, with added watermark\n  const mergedImage = await mergeImageURIs({\n    width: layer.context.deck.canvas.width,\n    height: layer.context.deck.canvas.height,\n    imageDataURLs: layerData,\n  })\n\n  var element = document.createElement('a')\n  element.setAttribute('href', mergedImage)\n  element.setAttribute('download', 'screenshot.png')\n  element.style.display = 'none'\n\n  document.body.appendChild(element)\n  element.click()\n  document.body.removeChild(element)\n}\n\n// copypasta from\n// https://stackoverflow.com/questions/32096540/merge-two-datauris-to-create-a-single-image\nfunction mergeImageURIs(props: { width: number; height: number; imageDataURLs: string[] }) {\n  return new Promise<any>((resolve, reject) => {\n    var canvas = document.createElement('canvas')\n    canvas.width = props.width\n    canvas.height = props.height\n\n    Promise.all(props.imageDataURLs.map(dataURL => add2canvas(canvas, dataURL))).then(() => {\n      // add watermark\n      const ctx = canvas.getContext('2d') as any\n      const boxLeft = canvas.width - 152\n      const boxTop = canvas.height - 8\n      ctx.beginPath()\n      ctx.rect(boxLeft - 4, boxTop - 14, 158, 22)\n      ctx.fillStyle = '#ffffff44'\n      ctx.fill()\n      ctx.font = '11px Arial'\n      ctx.fillStyle = '#888'\n      ctx.fillText('© Mapbox  © OpenStreetMap', boxLeft, boxTop)\n\n      // return final dataURL with fully-built image\n      resolve(canvas.toDataURL('image/png'))\n    })\n  })\n}\n\nfunction add2canvas(canvas: any, dataURL: string) {\n  return new Promise((resolve, reject) => {\n    if (!canvas) reject()\n    if (!dataURL) reject()\n\n    var image = new Image()\n\n    image.onload = function () {\n      canvas.getContext('2d').drawImage(this, 0, 0)\n      resolve(true)\n    }\n    image.src = dataURL\n  })\n}\n\nexport default { savePNG }\n"],"names":["Component","defineComponent","globalStore","viz","mapCamera","styles","maplibregl","jump","initial","startup","viewState","e","baubles","elem","value","bearing","longitude","latitude","zoom","pitch","ColorScheme","savePNG","layer","backgroundCanvas","deckLayerImage","backgroundImage","layerData","mergedImage","mergeImageURIs","element","props","resolve","reject","canvas","dataURL","add2canvas","ctx","boxLeft","boxTop","image","screenshots"],"mappings":"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"}