import{d as f,g as u,U as p,B as d,h,n as g}from"./index-24c2379b.js";import{V as y}from"./VuePlotly-0e863d69.js";import{b as x}from"./LayoutManager-3185e870.js";import{l as b}from"./lodash-ce477bae.js";import"./HTTPFileSystem-017e7593.js";import"./index-719eff74.js";import"./TopSheet-21dca6a3.js";import"./papaparse.min-e0a05c20.js";import"./DashboardDataManager-9bea9fc4.js";import"./util-8430d78c.js";import"./fxp-b80b6d05.js";import"./RoadNetworkLoader.worker-ba4f3b4d.js";import"./Coords-23d23a7c.js";import"./group-f6e6d4c5.js";import"./index-f6506551.js";const _=f({name:"HeatmapPanel",components:{VuePlotly:y},props:{fileSystemConfig:{type:Object,required:!0},subfolder:{type:String,required:!0},files:{type:Array,required:!0},config:{type:Object,required:!0},cardTitle:{type:String,required:!0},cardId:String,datamanager:{type:Object,required:!0},zoomed:Boolean},data:()=>({globalState:u.state,dataSet:{},id:"heatmap-"+Math.floor(1e12*Math.random()),YAMLrequirementsHeatmap:{dataset:"",y:""},layout:{margin:{t:8,b:50},font:{color:"#444444",family:p},barmode:"",bargap:.08,xaxis:{autorange:!0,title:""},yaxis:{autorange:!0,title:""},legend:{x:1,xanchor:"right",y:1},annotations:[]},data:[],options:{displaylogo:!1,responsive:!0,modeBarButtonsToRemove:["pan2d","zoom2d","select2d","lasso2d","zoomIn2d","zoomOut2d","autoScale2d","hoverClosestCartesian","hoverCompareCartesian","resetScale2d","toggleSpikelines","resetViewMapbox"],toImageButtonOptions:{format:"png",filename:"heatmap",width:1200,height:800,scale:1}}}),async mounted(){this.updateTheme(),this.checkWarningsAndErrors(),this.dataSet=await this.loadData(),Object.keys(this.dataSet).length&&(this.updateChart(),this.options.toImageButtonOptions.filename=x(this.cardTitle,this.subfolder),this.$emit("dimension-resizer",{id:this.cardId,resizer:this.changeDimensions})),this.$emit("isLoaded")},beforeDestroy(){var t;(t=this.datamanager)==null||t.removeFilterListener(this.config,this.handleFilterChanged)},watch:{zoomed(){this.resizePlot()},"globalState.isDarkMode"(){this.updateTheme()}},methods:{changeDimensions(t){this.layout=Object.assign({},this.layout,t)},resizePlot(){var t=document.getElementsByClassName("spinner-box");if(this.zoomed)for(let e of t)e.clientHeight>0&&(this.layout.height=e.clientHeight);else this.layout.height=300},updateTheme(){const t={paper_bgcolor:d[this.globalState.colorScheme],plot_bgcolor:d[this.globalState.colorScheme],font:{color:this.globalState.isDarkMode?"#cccccc":"#444444"}};this.layout=Object.assign({},this.layout,t)},handleFilterChanged(){if(!this.datamanager)return;const{filteredRows:t}=this.datamanager.getFilteredDataset(this.config);if(!t||!t.length)this.dataSet={allRows:{}};else{const e={},i=Object.keys(t[0]);i.forEach(s=>e[s]={name:s,values:[]}),t.forEach(s=>{i.forEach(l=>e[l].values.push(s[l]))}),this.dataSet={allRows:e}}this.updateChart()},async loadData(){try{this.validateYAML();let t=await this.datamanager.getDataset(this.config);if(!this.config.filters)return t;this.datamanager.addFilterListener(this.config,this.handleFilterChanged);for(const[e,i]of Object.entries(this.config.filters)){const s={dataset:this.config.dataset,column:e,value:i,range:Array.isArray(i)};this.datamanager.setFilter(s)}return{allRows:{}}}catch(t){console.error(""+t)}return{allRows:{}}},validateYAML(){for(const t in this.YAMLrequirementsHeatmap)t in this.config||this.$emit("error",{type:h.ERROR,msg:`YAML file missing required key: ${t}`,desc:"Check this.YAMLrequirementsXY for required keys"})},updateChart(){this.layout.xaxis.title=this.config.xAxisTitle||this.config.xAxisName||"",this.layout.yaxis.title=this.config.yAxisTitle||this.config.yAxisName||"";try{this.config.groupBy?this.updateChartWithGroupBy():this.updateChartSimple()}catch(t){const e=""+t;this.$emit("error",{type:h.ERROR,msg:e,desc:"Add a desription..."})}},updateChartWithGroupBy(){},updateChartSimple(){var t=[],e=[];const i=this.dataSet.allRows||{};let s=this.config.columns||this.config.usedCol||[];if(!s.length){let a=Object.keys(i);const r=this.config.y,o=a.indexOf(r,0);o>-1&&a.splice(o,1),s=a}if(!s.length)return;let l=!0;const c=["y"];for(const a of c)i[this.config[a]]||(this.$emit("error",`${this.cardTitle}: "${this.config.dataset}" ${c} column "${a}" missing`),l=!1);if(!l)return;let n=i[this.config.y].values;for(const a of Object.keys(i))s.includes(a)&&t.push(a);for(let a=0;a<s.length;a++)e[a]=i[s[a]].values;if(this.config.flipAxes||(n=n.reverse(),this.transpose(e),e=e.reverse()),this.data=[{x:this.config.flipAxes?n:t,y:this.config.flipAxes?t:n,z:e,colorscale:"Viridis",type:"heatmap",automargin:!0}],this.config.showLabels){this.layout.annotations.length=0;const a=this.data[0];for(let r=0;r<a.x.length;r++)for(let o=0;o<a.y.length;o++){const m={x:a.x[r],y:a.y[o],text:b.round(a.z[o][r],2),showarrow:!1,font:{family:"Arial Black",size:12,color:"white"}};this.layout.annotations.push(m)}}},transpose(t){for(let e=0;e<t.length;e++)for(let i=0;i<e;i++){const s=t[e][i];t[e][i]=t[i][e],t[i][e]=s}},checkWarningsAndErrors(){var t=this.cardTitle;t.length==0&&this.$emit("error",{type:h.WARNING,msg:"The plot title is missing!",desc:"Please add a plot title in the .yaml-file (title: 'Example title')"})}}});var v=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("VuePlotly",{staticClass:"myplot",attrs:{data:e.data,layout:e.layout,options:e.options,id:e.id}})},S=[];var C=g(_,v,S,!1,null,"8c9c1204",null,null);const F=C.exports;export{F as default};
//# sourceMappingURL=heatmap-7fa6d694.js.map
