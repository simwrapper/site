var W=Object.defineProperty;var U=(s,e,t)=>e in s?W(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var b=(s,e,t)=>(U(s,typeof e!="symbol"?e+"":e,t),t);import{R as f,d as $,n as q,r as A,g as y,k as M,M as X,C as E,L as _}from"./index-24c2379b.js";import{d as O}from"./index-2d3640f5.js";import{r as Y}from"./index-48474e4a.js";import{y as J}from"./index-719eff74.js";import{c as k}from"./index-4018348e.js";import{C as K}from"./CollapsiblePanel-4fe937e3.js";import{v as Z,f as Q,I as ee,P as te,a as se,b as ie,c as ae}from"./PathTraceLayer-1880ad72.js";import{Z as ne}from"./ZoomButtons-85071e8e.js";import{H as N}from"./HTTPFileSystem-017e7593.js";import{D as oe}from"./DashboardDataManager-9bea9fc4.js";import{W as re}from"./GzipFetcher.worker-baaf0850.js";import{a as le,g as ce}from"./util-8430d78c.js";import{D as he,S as ue}from"./set-rtl-text-plugin-40f27fec.js";import{A as me}from"./arc-layer-85831471.js";import{G as I}from"./index-a3e39363.js";import{L as de,p as ge,a as pe,M as fe,G as be,l as ve,A as Se,b as ye}from"./layer-7bd8a07e.js";import"./index-5ab379e4.js";import"./line-layer-c1ce1a7a.js";import"./RoadNetworkLoader.worker-ba4f3b4d.js";import"./Coords-23d23a7c.js";import"./group-f6e6d4c5.js";import"./index-f6506551.js";import"./fxp-b80b6d05.js";function Te(s){const e={display:"flex"},t={boxSizing:"border-box",float:"left",marginRight:"0.5rem"},i=s.items.map(a=>f.createElement("li",{key:a.value+a.value[0],style:s.mobile?t:e},a.label&&f.createElement("div",{style:{margin:"0 0.5rem 0.0rem 0",fontWeight:"bold"}},a.label),f.createElement("div",{style:{width:s.mobile?"3rem":"100%",height:"3px",marginTop:"0.5rem",backgroundColor:`rgb(${a.color})`}})));return f.createElement("div",null,f.createElement("h4",{style:{textAlign:"left",fontWeight:"bold",margin:"1rem 0 0.25rem 0",fontSize:"0.8rem"}},s.title),f.createElement("p",null,s.description),f.createElement("ul",{style:{listStyle:"none",padding:0,margin:0}},i))}const Ee={messages:{en:{requests:"DRT&nbsp;Requests",passengers:"Passengers",search:"Search",showhide:"Show/Hide",vehicles:"DRT Vehicles",routes:"Routes",speed:"Speed",backgroundTraffic:"All Traffic"},de:{requests:"DRT&nbsp;Anfragen",passengers:"Passagiere",search:"Suche",showhide:"Ein-/Ausblenden",vehicles:"DRT Fahrzeuge",routes:"Routen",speed:"Geschwindigkeit",backgroundTraffic:"Alle Fahrzeuge"}}},ke=$({name:"XmasSettingsPanel",i18n:Ee,components:{ToggleButton:O.ToggleButton},props:{items:{type:Object,required:!0}}});var we=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"settings-panel-content"},[t("h4",[e._v(e._s(e.$t("showhide")))]),t("div",{staticClass:"items"},e._l(Object.keys(e.items),function(i){return t("div",{key:i,staticClass:"row"},[t("toggle-button",{staticClass:"toggle",attrs:{width:40,value:e.items[i],labels:!1,color:{checked:"#4b7cc4",unchecked:"#222"}},on:{change:function(a){return e.$emit("click",i)}}}),t("label",{domProps:{innerHTML:e._s(e.$t(i))}})],1)}),0)])},Ce=[];var De=q(ke,we,Ce,!1,null,"d492d368",null,null);const Le=De.exports;function Ie(){return new Worker("/site/assets/MATSimEventStreamer.worker-1968cd1e.js")}class Me{constructor(e){b(this,"fileApi");b(this,"linkIdLookup",{});b(this,"network");b(this,"eventWorker");b(this,"eventLayers",[]);b(this,"range",[1/0,-1/0]);b(this,"timeRange",[1/0,-1/0]);b(this,"$emit",()=>{});b(this,"boundBox",[]);b(this,"params");this.params={...e},this.fileApi=new N(e.fileSystem),e.$emit&&(this.$emit=e.$emit),e.boundBox&&(this.boundBox=e.boundBox)}async loadFiles(){const{network:e,linkIdLookup:t}=await this.loadNetwork();this.network=e,this.linkIdLookup=t;try{let i=`${this.params.subfolder}/${this.params.vizDetails.events}`;return await this.streamEventFile(i)}catch(i){throw console.error(i),Error(""+i)}return[]}async loadNetwork(){let e=this.params.vizDetails.events.replace("events.xml","network.xml");const t=await this.params.dataManager.getRoadNetwork(e,this.params.subfolder,Object.assign({projection:"25833"},this.params.vizDetails)),i={};return t.linkIds.forEach((a,u)=>{i[`${a}`]=u}),{network:t,linkIdLookup:i}}streamEventFile(e){return new Promise((i,a)=>{const u=(m,c)=>{console.log("FINAL time",this.timeRange),this.$emit("finished"),this.eventWorker.terminate(),console.log("DONE: layers",this.eventLayers.length),console.log("ALL DONE",{totalRows:m,data:c.range,time:this.timeRange}),this.range=c.range,i(this.eventLayers)};this.$emit("status","Loading file...");let r=0;this.range=[1/0,-1/0],this.timeRange=[1/0,-1/0],this.eventWorker&&this.eventWorker.terminate(),this.eventLayers=[],this.eventWorker=new Ie;const o=Intl.NumberFormat();this.eventWorker.onmessage=async m=>{const c=m.data;if(c.status)this.$emit("status",c.status);else{if(c.error)throw Error(c.error);if(c.finished){u(r,c);return}else{const d=c.events;console.log(d.length),r+=d.length,this.$emit("status","Loading "+o.format(r)+" events..."),this.timeRange=[Math.min(this.timeRange[0],d[0].time),Math.max(this.timeRange[1],d[d.length-1].time)],this.timeRange=[Math.min(this.timeRange[0],c.vehicleTrips[0].t0),Math.max(this.timeRange[1],c.vehicleTrips[c.vehicleTrips.length-1].t1)];let v=c.vehicleTrips;if(console.log("ROIGINAL LENGHT",v.length),this.boundBox.length){const l=this.network.source,S=this.network.dest;v=c.vehicleTrips.filter(T=>{const p=2*this.linkIdLookup[T.link];return l[p]>this.boundBox[0][0]&&l[p]<this.boundBox[1][0]&&l[p+1]>this.boundBox[0][1]&&l[p+1]<this.boundBox[1][1]&&S[p]>this.boundBox[0][0]&&S[p]<this.boundBox[1][0]&&S[p+1]>this.boundBox[0][1]&&S[p+1]<this.boundBox[1][1]}),console.log("FILTERED LENGTH:",v.length)}const g=v.length,h={locO:new Float32Array(2*g).fill(NaN),locD:new Float32Array(2*g).fill(NaN),t0:new Float32Array(g).fill(NaN),t1:new Float32Array(g).fill(NaN)};for(let l=0;l<g;l++){const S=v[l],T=2*this.linkIdLookup[S.link];h.locO[l*2+0]=this.network.source[0+T],h.locO[l*2+1]=this.network.source[1+T],h.locD[l*2+0]=this.network.dest[0+T],h.locD[l*2+1]=this.network.dest[1+T],l==0?(h.locO[l*2+0]=.5*(h.locO[l*2+0]+h.locD[l*2+0]),h.locO[l*2+1]=.5*(h.locO[l*2+1]+h.locD[l*2+1])):l==g-1&&(h.locD[l*2+0]=.5*(h.locO[l*2+0]+h.locD[l*2+0]),h.locD[l*2+1]=.5*(h.locO[l*2+1]+h.locD[l*2+1])),h.t0[l]=S.t0,h.t1[l]=S.t1}this.eventLayers.push({vehicles:h})}}},this.eventWorker.postMessage({filePath:e,fileSystem:this.params.fileSystem,projection:this.params.vizDetails.projection,boundBox:this.boundBox})})}}const ze={currentTime:{type:"number",value:0,min:0},getTimeStart:{type:"accessor",value:null},getTimeEnd:{type:"accessor",value:null},searchFlag:{type:"number",value:0}};class z extends me{getShaders(){const e=super.getShaders();return e.inject={"vs:#decl":`        attribute float timeStart;
        attribute float timeEnd;
        uniform float currentTime;
        uniform float searchFlag;
        varying float vTime;
      `,"vs:#main-start":`        if (searchFlag == 1.0) {
          vTime = 999.0;
        } else if (timeEnd == -1.0 || timeStart > currentTime || timeEnd < currentTime ) {
          vTime = -1.0;
          return;
        } else {
          float nearBeginning = currentTime - timeStart;
          float nearEnd = timeEnd - currentTime;
          vTime = min(nearBeginning, nearEnd);
        }
      `,"fs:#decl":`        uniform float currentTime;
        uniform float searchFlag;
        varying float vTime;
      `,"fs:#main-start":`      if (searchFlag == 0.0 && vTime == -1.0 ) discard;
      `,"fs:DECKGL_FILTER_COLOR":`        if (vTime <= 10.0) color.a *= (vTime / 10.0);
      `},e}initializeState(e){super.initializeState(e),this.getAttributeManager().addInstanced({timeStart:{size:1,accessor:"getTimeStart"},timeEnd:{size:1,accessor:"getTimeEnd"}})}draw(e){const{currentTime:t}=this.props;e.uniforms=Object.assign({},e.uniforms,{currentTime:t}),super.draw(e)}}z.layerName="DrtRequestArcLayer";z.defaultProps=ze;const B=[0,0,0,255],Re={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!1,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},iconStill:{type:"object",value:null},getIcon:{type:"accessor",value:"vehicle"},getBOffsets:{type:"accessor",value:[0,0]},getBIconFrames:{type:"accessor",value:[128,128,128,128]},getBColorModes:{type:"accessor",value:1},getColor:{type:"accessor",value:B},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getPathStart:{type:"accessor",value:null},getPathEnd:{type:"accessor",value:null},getTimeStart:{type:"accessor",value:null},getTimeEnd:{type:"accessor",value:null},currentTime:{type:"number",value:0},pickable:{type:"boolean",value:!0},onIconError:{type:"function",value:null,compare:!1,optional:!0}};class R extends de{getShaders(){return super.getShaders({vs:Z,fs:Q,modules:[ge,pe]})}initializeState(){this.state={iconManager:new ee(this.context.gl,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instanceTimestamps:{size:1,accessor:"getTimeStart"},instanceTimestampsNext:{size:1,accessor:"getTimeEnd"},instanceStartPositions:{size:2,accessor:"getPathStart"},instanceEndPositions:{size:2,accessor:"getPathEnd"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,defaultValue:[0,0],accessor:"getBOffsets"},instanceIconFrames:{size:4,defaultValue:[0,0,128,128],accessor:"getBIconFrames"},instanceColorModes:{size:1,type:I.UNSIGNED_BYTE,defaultValue:1,accessor:"getBColorModes"},instanceColors:{size:this.props.colorFormat.length,type:I.UNSIGNED_BYTE,normalized:!0,transition:!0,accessor:"getColor",defaultValue:B},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState({oldProps:e,props:t,changeFlags:i}){var g;super.updateState({props:t,oldProps:e,changeFlags:i});const a=this.getAttributeManager(),{iconAtlas:u,iconMapping:r,data:o,getIcon:m}=t,{iconManager:c}=this.state;c.setProps({loadOptions:t.loadOptions});let d=!1;if(u||this.internalState.isAsyncPropLoading("iconAtlas")?(e.iconAtlas!==t.iconAtlas&&c.setProps({iconAtlas:u,autoPacking:!1}),e.iconMapping!==t.iconMapping&&(c.setProps({iconMapping:r}),d=!0)):c.setProps({autoPacking:!0}),(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getIcon))&&c.setProps({data:o,getIcon:m}),d&&(a.invalidate("instanceOffsets"),a.invalidate("instanceIconFrames"),a.invalidate("instanceColorModes")),i.extensionsChanged){const{gl:h}=this.context;(g=this.state.model)==null||g.delete(),this.state.model=this._getModel(h),a.invalidateAll()}}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(){super.finalizeState(),this.state.iconManager.finalize()}draw({uniforms:e}){const{sizeScale:t,sizeMinPixels:i,sizeMaxPixels:a,sizeUnits:u,billboard:r,alphaCutoff:o,currentTime:m,iconStill:c,pickable:d}=this.props,{iconManager:v}=this.state,{viewport:g}=this.context,h=v.getTexture();h&&this.state.model.setUniforms(e).setUniforms({iconsTexture:h,iconsTextureDim:[h.width,h.height],sizeScale:t*(u==="pixels"?g.metersPerPixel:1),sizeMinPixels:i,sizeMaxPixels:a,billboard:r,alphaCutoff:o,currentTime:m,pickable:d,iconStillOffsets:this.getInstanceOffset(c),iconStillFrames:this.getInstanceIconFrame(c)}).draw()}_getModel(e){const t=[-1,-1,-1,1,1,1,1,-1];return new fe(e,{...this.getShaders(),id:this.props.id,geometry:new be({drawMode:I.TRIANGLE_FAN,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){const{onIconError:t}=this.getCurrentLayer().props;t?t(e):ve.error(e.error)()}getInstanceOffset(e){const t=this.state.iconManager.getIconMapping(e);return[t.width/2-t.anchorX||0,t.height/2-t.anchorY||0]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){const t=this.state.iconManager.getIconMapping(e);return[t.x||0,t.y||0,t.width||0,t.height||0]}}R.layerName="FlatIconLayer";R.defaultProps=Re;const P="/site/",F={marker:{x:0,y:0,width:128,height:128,mask:!0},info:{x:128,y:0,width:128,height:128,mask:!0},vehicle:{x:128,y:128,width:128,height:128,mask:!0},diamond:{x:0,y:128,width:128,height:128,mask:!1}},xe=new Se({color:[255,255,255],intensity:1}),Ae=new te({color:[255,255,255],intensity:2,position:[-74.05,40.7,8e3]}),_e=new ye({ambientLight:xe,pointLight:Ae}),Pe={vehicleColor:[200,130,250],trailColor0:[235,235,25],trailColor1:[23,184,190],effects:[_e]},w={time:0,fromX:1,fromY:2,toX:3,toY:4,veh:5,arrival:6};function Fe(s){const{simulationTime:e,paths:t,traces:i,drtRequests:a,settingsShowLayers:u,center:r,dark:o,vehicleLookup:m,searchEnabled:c,onClick:d,viewId:v,trafficLayers:g}=s,h=Pe,[l,S]=A.useState(r?{center:[16,42],longitude:r[0],latitude:r[1],pitch:0,bearing:0,zoom:10}:Object.assign({},y.state.viewState));M[v]=()=>{S(y.state.viewState)};const T=2,[p,x]=A.useState({}),C=[];function V(){console.log(p),p.object?d(p.object.v):d(null)}function j({hoverInfo:n}){const{object:D,x:L,y:G}=n;if(!D)return null;const H=m[D.v];return f.createElement("div",{className:"tooltip",style:{fontSize:"0.8rem",backgroundColor:"#ddddeedd",borderLeft:"6px solid green",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#223",padding:"1rem 1rem",position:"absolute",left:L+40,top:G-30}},f.createElement("big",null,f.createElement("b",null,H)),f.createElement("div",null,"Passagiere: ",D.occ," "))}return u.backgroundTraffic&&g.forEach((n,D)=>{const L=n.vehicles.t0[0]>e||n.vehicles.t1[n.vehicles.t1.length-1]<e;C.push(new R({data:{length:n.vehicles.t0.length,attributes:{getTimeStart:{value:n.vehicles.t0,size:1},getTimeEnd:{value:n.vehicles.t1,size:1},getPathStart:{value:n.vehicles.locO,size:2},getPathEnd:{value:n.vehicles.locD,size:2}}},id:"vehicles"+D,getColor:[255,32,32],iconMoving:"vehicle",iconStill:"diamond",getSize:20,opacity:1,currentTime:e,shadowEnabled:!0,iconAtlas:`${P}/icon-atlas.png`,iconMapping:F,sizeScale:1,billboard:!1,pickable:!0,depthTest:!0,autoHighlight:!1,highlightColor:[255,0,255],parameters:{depthTest:!1},visible:!L}))}),u.routes&&C.push(new se({id:"Routen",data:i,currentTime:e,getSourcePosition:n=>n.p0,getTargetPosition:n=>n.p1,getTimeStart:n=>n.t0,getTimeEnd:n=>n.t1,getColor:n=>s.colors[n.occ],getWidth:3,opacity:.8,widthMinPixels:1,rounded:!1,shadowEnabled:!1,searchFlag:c?1:0,pickable:!0,autoHighlight:!0,highlightColor:[255,0,255],onHover:x})),u.vehicles&&C.push(new ie({id:"Vehicles",data:t,getPathStart:n=>n.p0,getPathEnd:n=>n.p1,getTimeStart:n=>n.t0,getTimeEnd:n=>n.t1,getIcon:n=>"vehicle",getColor:n=>s.colors[n.occ],iconMoving:"vehicle",iconStill:"diamond",getSize:128,opacity:1,currentTime:e,shadowEnabled:!1,noAlloc:!0,iconAtlas:`${P}/icon-atlas.png`,iconMapping:F,sizeScale:.5,billboard:!1,pickable:!0,depthTest:!0,autoHighlight:!1,highlightColor:[255,0,255],onHover:x,parameters:{depthTest:!1}})),u.requests&&C.push(new z({id:"DRT Requests",data:a,currentTime:e,getSourcePosition:n=>[n[w.fromX],n[w.fromY]],getTargetPosition:n=>[n[w.toX],n[w.toY]],getTimeStart:n=>n[w.time],getTimeEnd:n=>n[w.arrival],getSourceColor:[0,255,64],getTargetColor:[0,255,64],getWidth:T,opacity:.5,searchFlag:c?1:0})),f.createElement(he,{layers:C,effects:h.effects,pickingRadius:5,viewState:l,controller:!0,getCursor:()=>"pointer",onClick:V,onViewStateChange:n=>{y.commit("setMapCamera",n.viewState)}},f.createElement(ue,{mapStyle:y.getters.mapStyle,mapboxApiAccessToken:X}),j({hoverInfo:p}))}const $e={messages:{en:{requests:"DRT Requests",passengers:"Passengers",search:"Search",showhide:"Show/Hide",vehicles:"Vehicles",routes:"Routes",speed:"Speed"},de:{requests:"DRT Anfragen",passengers:"Passagiere",search:"Suche",showhide:"Ein-/Ausblenden",vehicles:"DRT Fahrzeuge",routes:"DRT Routen",speed:"Geschwindigkeit"}}},qe=$({name:"XmasVehicleAnimation",i18n:$e,components:{CollapsiblePanel:K,SettingsPanel:Le,LegendColors:Te,TripViz:Fe,PlaybackControls:ae,ToggleButton:O.ToggleButton,ZoomButtons:ne},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean},computed:{fileApi(){return new N(this.fileSystem,y)},fileSystem(){const s=this.$store.state.svnProjects.filter(e=>e.slug===this.root);if(s.length===0)throw console.log("no such project"),Error;return s[0]},urlThumbnail(){return this.thumbnailUrl},textColor(){const s={text:"#3498db",bg:"#eeeef480"},e={text:"white",bg:"#181518aa"};return this.myState.colorScheme===E.DarkMode?e:s}},data:()=>{const s={0:[140,140,160],1:[20,224,224],2:[240,240,40],3:[240,110,30]};return{viewId:Math.floor(1e12*Math.random()),COLOR_OCCUPANCY:s,SETTINGS:{vehicles:!0,backgroundTraffic:!0,routes:!0,requests:!0},legendItems:Object.keys(s).map(e=>({type:_.line,color:s[e],value:e,label:e})),legendRequests:[{type:_.line,color:[255,0,255],value:0,label:""}],vizDetails:{network:"",drtTrips:"",projection:"",title:"",description:"",thumbnail:"",center:[13.45,52.5],zoom:12,bearing:0,pitch:20,mapIsIndependent:!1,events:"",eventBlobs:[],theme:""},myState:{statusMessage:"",clock:"00:00",colorScheme:E.DarkMode,isRunning:!1,isShowingHelp:!1,subfolder:"",yamlConfig:"",thumbnail:!1,data:[]},timeStart:0,timeEnd:86400,traces:k([]),traceStart:null,traceEnd:null,traceVehicle:null,paths:k([]),pathStart:null,pathEnd:null,pathVehicle:null,requests:k([]),requestStart:null,requestEnd:null,requestVehicle:null,simulationTime:6*3600,timeElapsedSinceLastFrame:0,searchTerm:"",searchEnabled:!1,globalState:y.state,isDarkMode:y.state.colorScheme===E.DarkMode,isLoaded:!1,showHelp:!1,speedStops:[-10,-5,-2,-1,-.5,-.25,0,.25,.5,1,2,5,10],speed:1,trafficLayers:[],legendBits:[],isEmbedded:!1,thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",vehicleLookup:[],vehicleLookupString:{},isPausedDueToHiding:!1}},watch:{"$store.state.viewState"(){this.vizDetails.mapIsIndependent||M[this.viewId]&&M[this.viewId]()},async"globalState.authAttempts"(){console.log("AUTH CHANGED - Reload"),this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails()},"globalState.colorScheme"(){this.isDarkMode=this.globalState.colorScheme===E.DarkMode,this.updateLegendColors()},searchTerm(){var e,t,i,a,u,r,o,m;const s=this.vehicleLookupString[this.searchTerm];s>-1?(console.log("vehicle",s),(e=this.pathVehicle)==null||e.filterExact(s),(t=this.traceVehicle)==null||t.filterExact(s),(i=this.requestVehicle)==null||i.filterExact(s),(a=this.requestStart)==null||a.filterAll(),(u=this.requestEnd)==null||u.filterAll(),this.searchEnabled=!0):(console.log("nope"),(r=this.pathVehicle)==null||r.filterAll(),(o=this.traceVehicle)==null||o.filterAll(),(m=this.requestVehicle)==null||m.filterAll(),this.searchEnabled=!1),this.updateDatasetFilters()}},async mounted(){if(y.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.yamlConfig=this.yamlConfig||"",this.myState.subfolder=this.subfolder,this.setEmbeddedMode(),await this.getVizDetails(),this.thumbnail)return;this.showHelp=!1,this.updateLegendColors(),this.setWallClock(),this.myState.statusMessage="/ Dateien laden...",console.log("loading files");const{trips:s,drtRequests:e}=await this.loadFiles();console.log("parsing vehicle motion"),this.myState.statusMessage=`${this.$t("vehicles")}...`,this.paths=await this.parseVehicles(s),this.pathStart=this.paths.dimension(t=>t.t0),this.pathEnd=this.paths.dimension(t=>t.t1),this.pathVehicle=this.paths.dimension(t=>t.v),console.log("Routes..."),this.myState.statusMessage=`${this.$t("routes")}...`,this.traces=await this.parseRouteTraces(s),this.traceStart=this.traces.dimension(t=>t.t0),this.traceEnd=this.traces.dimension(t=>t.t1),this.traceVehicle=this.traces.dimension(t=>t.v),console.log("Requests..."),this.myState.statusMessage=`${this.$t("requests")}...`,this.requests=await this.parseDrtRequests(e),this.requestStart=this.requests.dimension(t=>t[0]),this.requestEnd=this.requests.dimension(t=>t[6]),this.requestVehicle=this.requests.dimension(t=>t[5]),this.loadBackgroundTraffic(),console.log("GO!"),this.myState.statusMessage="",document.addEventListener("visibilitychange",this.handleVisibilityChange,!1),this.myState.isRunning=!0,this.timeElapsedSinceLastFrame=Date.now(),this.animate()},beforeDestroy(){document.removeEventListener("visibilityChange",this.handleVisibilityChange),y.commit("setFullScreen",!1),this.$store.commit("setFullScreen",!1),this.myState.isRunning=!1},methods:{handleClick(s){if(s===null){this.searchTerm="";return}const e=this.vehicleLookup[s];console.log(e),this.searchTerm===e?this.searchTerm="":this.searchTerm=e},updateLegendColors(){},setWallClock(){const s=Math.floor(this.simulationTime/3600),e=Math.floor(this.simulationTime/60)%60;this.myState.clock=`${s<10?"0":""}${s}${e<10?":0":":"}${e}`},setTime(s){var e,t,i;this.simulationTime=s,this.setWallClock(),this.traceStart&&this.pathStart&&this.requestStart&&(this.pathStart.filter([0,this.simulationTime]),(e=this.pathEnd)==null||e.filter([this.simulationTime,1/0]),this.searchEnabled||(this.traceStart.filter([0,this.simulationTime]),(t=this.traceEnd)==null||t.filter([this.simulationTime,1/0]),this.requestStart.filter([0,this.simulationTime]),(i=this.requestEnd)==null||i.filter([this.simulationTime,1/0]))),this.$options.paths=this.paths.allFiltered(),this.$options.traces=this.traces.allFiltered(),this.$options.drtRequests=this.requests.allFiltered()},toggleSimulation(){console.log("CLICK !!!"),this.myState.isRunning=!this.myState.isRunning,this.timeElapsedSinceLastFrame=Date.now(),this.myState.isRunning&&this.speed===0&&(this.speed=1),this.myState.isRunning&&this.animate()},async loadBackgroundTraffic(){if(this.vizDetails.eventBlobs)for(const s of this.vizDetails.eventBlobs){const e=await this.loadBackgroundChunk(s);this.trafficLayers.push(e)}else if(this.vizDetails.events){const e=await new Me({fileSystem:this.fileSystem,dataManager:new oe(this.root,this.subfolder),vizDetails:this.vizDetails,subfolder:this.subfolder}).loadFiles();this.trafficLayers=e,this.exportJSON(e)}},async loadBackgroundChunk(s){return new Promise((e,t)=>{console.log("load chunk:",s);const i=new re;i.onmessage=a=>{const r=new Float32Array(a.data.buffer).length/6,o=4,m={vehicles:{locO:new Float32Array(a.data.buffer,0,r*2),locD:new Float32Array(a.data.buffer,o*r*2,r*2),t0:new Float32Array(a.data.buffer,o*r*4,r),t1:new Float32Array(a.data.buffer,o*r*5,r)}};e(m)},i.postMessage({filePath:this.myState.subfolder+"/"+s,fileSystem:this.fileSystem})})},exportJSON(s){for(const e of s){const t=new Blob([e.vehicles.locO,e.vehicles.locD,e.vehicles.t0,e.vehicles.t1],{type:"octet/stream"}),i=URL.createObjectURL(t);let a=document.createElement("a");a.setAttribute("href",i),a.setAttribute("download","events.blob"),a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a)}},setEmbeddedMode(){"embed"in this.$route.query&&(console.log("EMBEDDED MODE"),this.isEmbedded=!0,this.$store.commit("setShowLeftBar",!1),this.$store.commit("setFullWidth",!0))},async handleSettingChange(s){console.log(s),this.SETTINGS[s]=!this.SETTINGS[s],this.updateDatasetFilters(),this.simulationTime+=1},buildRouteFromUrl(){const s=this.$route.params;if(!s.project||!s.pathMatch){console.log("I CANT EVEN: NO PROJECT/PARHMATCH");return}const e=1+s.pathMatch.lastIndexOf("/"),t=s.pathMatch.substring(0,e),i=s.pathMatch.substring(e);this.myState.subfolder=t,this.myState.yamlConfig=i},async getVizDetails(){console.log("GETVIZ");try{const e=this.myState.yamlConfig.indexOf("/")>-1?this.myState.yamlConfig:this.myState.subfolder+"/"+this.myState.yamlConfig,t=await this.fileApi.getFileText(e);this.vizDetails=J.parse(t)}catch(e){console.log("failed");const t=e;this.fileSystem.needPassword&&t.status===401&&y.commit("requestLogin",this.fileSystem.slug)}this.vizDetails.theme&&this.$store.commit("setTheme",this.vizDetails.theme),this.vizDetails.center&&this.$store.commit("setMapCamera",{longitude:this.vizDetails.center[0],latitude:this.vizDetails.center[1],zoom:this.vizDetails.zoom||11,pitch:this.vizDetails.pitch||20,bearing:this.vizDetails.bearing||0,jump:!0});const s=this.vizDetails.title?this.vizDetails.title:"Agent Animation";this.$emit("title",s),this.buildThumbnail(),this.isLoaded=!0},async buildThumbnail(){if(this.thumbnail&&this.vizDetails.thumbnail)try{const s=await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail),e=await Y.arraybuffer(s),t=le(e);t&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${t})`)}catch(s){console.error(s)}},async parseDrtRequests(s){if(this.vehicleLookup.length)for(const e of s)try{e[5]=this.vehicleLookupString[e[5]]}catch{}return k(s)},async parseVehicles(s){const e=[];let t=-1;for(const i of s){const a=i.path,u=i.timestamps,r=i.passengers;t++,this.vehicleLookup[t]=i.id,this.vehicleLookupString[i.id]=t;for(let o=0;o<i.path.length-1;o++)e.push({t0:u[o],t1:u[o+1],p0:a[o],p1:a[o+1],v:t,occ:r[o]})}return k(e)},updateDatasetFilters(){var s,e,t,i,a;!this.traceStart||!this.pathStart||!this.requestStart||(this.SETTINGS.routes&&(this.searchEnabled?(this.traceStart.filterAll(),(s=this.traceEnd)==null||s.filterAll()):(this.traceStart.filter([0,this.simulationTime]),(e=this.traceEnd)==null||e.filter([this.simulationTime,1/0])),this.$options.traces=this.traces.allFiltered()),this.SETTINGS.vehicles&&(this.pathStart.filter([0,this.simulationTime]),(t=this.pathEnd)==null||t.filter([this.simulationTime,1/0]),this.$options.paths=this.paths.allFiltered()),this.SETTINGS.requests&&(this.searchEnabled?(this.requestStart.filterAll(),(i=this.requestEnd)==null||i.filterAll()):(this.requestStart.filter([0,this.simulationTime]),(a=this.requestEnd)==null||a.filter([this.simulationTime,1/0])),this.$options.drtRequests=this.requests.allFiltered()))},animate(){if(this.myState.isRunning){const s=Date.now()-this.timeElapsedSinceLastFrame;this.timeElapsedSinceLastFrame+=s,this.simulationTime+=s*this.speed*.05,this.updateDatasetFilters(),this.setWallClock(),window.requestAnimationFrame(this.animate)}},handleVisibilityChange(){this.isPausedDueToHiding&&!document.hidden?(console.log("unpausing"),this.isPausedDueToHiding=!1,this.toggleSimulation()):this.myState.isRunning&&document.hidden&&(console.log("pausing"),this.isPausedDueToHiding=!0,this.toggleSimulation())},async parseRouteTraces(s){let e=-1;const t=[];for(const i of s){e++;let a=i.timestamps[0],u=i.timestamps[0],r=[];for(let o=1;o<i.path.length;o++)u=i.timestamps[o],i.path[o][0]===i.path[o-1][0]&&i.path[o][1]===i.path[o-1][1]?(r.forEach(m=>{m.t1=i.timestamps[o-1]}),t.push(...r),r=[],a=u):r.push({t0:a,p0:i.path[o-1],p1:i.path[o],v:e,occ:i.passengers[o-1]});r.forEach(o=>{o.t1=u}),t.push(...r)}return k(t)},async loadFiles(){if(!this.fileApi)return{trips:[],drtRequests:{}};let s=[],e=[];try{if(this.vizDetails.drtTrips.endsWith("json")){const t=await this.fileApi.getFileJson(this.myState.subfolder+"/"+this.vizDetails.drtTrips);s=t.trips,e=t.drtRequests}else if(this.vizDetails.drtTrips.endsWith("gz")){const i=await(await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.drtTrips)).arrayBuffer(),a=ce(i),u=new TextDecoder("utf-8").decode(a),r=JSON.parse(u);s=r.trips,e=r.drtRequests}}catch(t){console.error(t),this.myState.statusMessage=""+t}return{trips:s,drtRequests:e}},toggleLoaded(s){this.isLoaded=s},rotateColors(){this.myState.colorScheme=this.myState.colorScheme===E.DarkMode?E.LightMode:E.DarkMode,localStorage.setItem("plugin/agent-animation/colorscheme",this.myState.colorScheme)}}});var Oe=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"gl-app",class:{"hide-thumbnail":!e.thumbnail},style:{background:e.urlThumbnail},attrs:{oncontextmenu:"return false"}},[e.thumbnail?e._e():t("trip-viz",{staticClass:"anim",attrs:{center:e.vizDetails.center,colors:e.COLOR_OCCUPANCY,drtRequests:e.$options.drtRequests,dark:e.globalState.isDarkMode,paths:e.$options.paths,settingsShowLayers:e.SETTINGS,searchEnabled:e.searchEnabled,simulationTime:e.simulationTime,traces:e.$options.traces,vehicleLookup:e.vehicleLookup,viewId:e.viewId,onClick:e.handleClick,trafficLayers:e.trafficLayers}}),e.thumbnail?e._e():t("zoom-buttons"),t("div",{staticClass:"bottom-controls-mobile"},[t("div",{staticClass:"big clock"},[t("p",[e._v(e._s(e.myState.clock))])]),e.legendItems.length?t("legend-colors",{staticClass:"legend-block",attrs:{mobile:!0,title:`${e.$t("passengers")}:`,items:e.legendItems}}):e._e(),t("settings-panel",{staticClass:"settings-area",attrs:{items:e.SETTINGS},on:{click:e.handleSettingChange}})],1),e.isLoaded&&!e.thumbnail?t("div",{staticClass:"right-side"},[t("collapsible-panel",{attrs:{direction:"right"}},[t("div",{staticClass:"big clock"},[t("p",[e._v(e._s(e.myState.clock))])]),t("div",{staticClass:"panel-items"},[e.legendItems.length?t("legend-colors",{staticClass:"legend-block",attrs:{title:`${e.$t("passengers")}:`,items:e.legendItems}}):e._e(),t("legend-colors",{staticClass:"legend-block",attrs:{title:`${e.$t("requests")}:`,items:e.legendRequests,mobile:!1}}),t("settings-panel",{staticClass:"settings-area",attrs:{items:e.SETTINGS},on:{click:e.handleSettingChange}}),t("div",{staticClass:"speed-block"},[t("p",{staticClass:"speed-label"},[e._v(e._s(e.$t("speed"))+":"),t("br"),e._v(e._s(e.speed)+"x")]),t("b-slider",{staticClass:"speed-slider",attrs:{min:e.speedStops[0],max:e.speedStops[e.speedStops.length-1],duration:0,dotSize:20,tooltip:!0,"tooltip-placement":"bottom","tooltip-formatter":i=>i+"x"},model:{value:e.speed,callback:function(i){e.speed=i},expression:"speed"}},[e._l(e.speedStops,function(i){return[t("b-slider-tick",{key:i,attrs:{value:i}})]})],2)],1)],1)])],1):e._e(),!e.thumbnail&&e.isLoaded?t("playback-controls",{staticClass:"bottom-area",attrs:{timeStart:e.timeStart,timeEnd:e.timeEnd,isRunning:e.myState.isRunning,currentTime:e.simulationTime},on:{click:e.toggleSimulation,time:e.setTime}}):e._e()],1)},Ne=[];var Be=q(qe,Oe,Ne,!1,null,"f0ba60e6",null,null);const mt=Be.exports;export{mt as default};
//# sourceMappingURL=VehicleAnimation-1221f461.js.map
